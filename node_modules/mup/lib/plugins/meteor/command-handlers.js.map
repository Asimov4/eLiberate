{"version":3,"sources":["../../../src/plugins/meteor/command-handlers.js"],"names":["api","log","config","getConfig","app","console","error","process","exit","appPath","resolvePath","getBasePath","path","buildOptions","buildLocation","tmpBuildPath","bundlePath","rebuild","getOptions","buildCached","existsSync","getVerbose","list","taskList","copy","src","dest","name","progressBar","enableUploadProgressBar","prepareSupported","docker","image","indexOf","prepareBundle","supportedScript","__dirname","unsupportedScript","executeScript","script","vars","appName","dockerImage","env","sessions","getSessions","runTaskList","series","verbose","push","logs","setup","envconfig","start","deploy","stop","restart","rand","create","uuidNumbers","i","tmpdir","v4","random","args","getArgs","shift","getDockerLogs","ssl","autogenerate","basePath","upload","crt","key","servers","bindAddress","opts","nginx","bind","dockerImageFrontendServer","imageFrontendServer","imagePort","port","PORT","sslConfig","logConfig","volumes","proxyConfig","proxy","nginxClientUploadLimit","clientUploadLimit","METEOR_SETTINGS","JSON","stringify","getSettings","hostVars","Object","keys","forEach","host","deployCheckWaitTime","deployCheckPort","deployCheckPath","domains","split","runCommand","then"],"mappings":"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","file":"command-handlers.js","sourcesContent":["import buildApp from './build.js';\nimport { cloneDeep } from 'lodash';\nimport debug from 'debug';\nimport fs from 'fs';\nimport nodemiral from 'nodemiral';\nimport os from 'os';\nimport random from 'random-seed';\nimport uuid from 'uuid';\n\nconst log = debug('mup:module:meteor');\n\nfunction tmpBuildPath(appPath, api) {\n  let rand = random.create(appPath);\n  let uuidNumbers = [];\n  for (let i = 0; i < 16; i++) {\n    uuidNumbers.push(rand(255));\n  }\n  return api.resolvePath(\n    os.tmpdir(),\n    `mup-meteor-${uuid.v4({ random: uuidNumbers })}`\n  );\n}\n\nexport function logs(api) {\n  log('exec => mup meteor logs');\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  const args = api.getArgs();\n  if (args[0] === 'meteor') {\n    args.shift();\n  }\n\n  const sessions = api.getSessions(['app']);\n  return api.getDockerLogs(config.name, sessions, args);\n}\n\nexport function setup(api) {\n  log('exec => mup meteor setup');\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  const list = nodemiral.taskList('Setup Meteor');\n\n  list.executeScript('Setup Environment', {\n    script: api.resolvePath(__dirname, 'assets/meteor-setup.sh'),\n    vars: {\n      name: config.name\n    }\n  });\n\n  if (config.ssl && typeof config.ssl.autogenerate !== 'object') {\n    const basePath = api.getBasePath();\n\n    if (config.ssl.upload !== false) {\n      list.executeScript('Cleaning up SSL Certificates', {\n        script: api.resolvePath(__dirname, 'assets/ssl-cleanup.sh'),\n        vars: {\n          name: config.name\n        }\n      });\n      list.copy('Copying SSL Certificate Bundle', {\n        src: api.resolvePath(basePath, config.ssl.crt),\n        dest: '/opt/' + config.name + '/config/bundle.crt'\n      });\n\n      list.copy('Copying SSL Private Key', {\n        src: api.resolvePath(basePath, config.ssl.key),\n        dest: '/opt/' + config.name + '/config/private.key'\n      });\n    }\n\n    list.executeScript('Verifying SSL Configurations', {\n      script: api.resolvePath(__dirname, 'assets/verify-ssl-config.sh'),\n      vars: {\n        name: config.name\n      }\n    });\n  }\n\n  const sessions = api.getSessions(['app']);\n\n  return api.runTaskList(list, sessions, { verbose: api.verbose });\n}\n\nexport async function push(api) {\n  log('exec => mup meteor push');\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  const appPath = api.resolvePath(api.getBasePath(), config.path);\n\n  let buildOptions = config.buildOptions || {};\n  buildOptions.buildLocation =\n    buildOptions.buildLocation || tmpBuildPath(appPath, api);\n\n  var bundlePath = api.resolvePath(buildOptions.buildLocation, 'bundle.tar.gz');\n  var rebuild = true;\n\n  if (api.getOptions()['cached-build']) {\n    const buildCached = fs.existsSync(bundlePath);\n    if (!buildCached) {\n      console.log('Unable to use previous build. It doesn\\'t exist.');\n    } else {\n      rebuild = false;\n      console.log('Not building app. Using build from previous deploy at');\n      console.log(buildOptions.buildLocation);\n    }\n  }\n\n  if (rebuild) {\n    console.log('Building App Bundle Locally');\n    await buildApp(appPath, buildOptions, api.getVerbose(), api);\n  }\n\n  const list = nodemiral.taskList('Pushing Meteor App');\n\n  list.copy('Pushing Meteor App Bundle to The Server', {\n    src: bundlePath,\n    dest: '/opt/' + config.name + '/tmp/bundle.tar.gz',\n    progressBar: config.enableUploadProgressBar\n  });\n\n  let prepareSupported = config.docker.image.indexOf('abernix/meteord') === 0;\n  if ('prepareBundle' in config.docker) {\n    prepareSupported = config.docker.prepareBundle;\n  }\n\n  const supportedScript = api.resolvePath(\n    __dirname,\n    'assets/prepare-bundle.sh'\n  );\n  const unsupportedScript = api.resolvePath(\n    __dirname,\n    'assets/prepare-bundle-unsupported.sh'\n  );\n\n  list.executeScript('Prepare Bundle', {\n    script: prepareSupported ? supportedScript : unsupportedScript,\n    vars: {\n      appName: config.name,\n      dockerImage: config.docker.image,\n      env: config.env\n    }\n  });\n\n  const sessions = api.getSessions(['app']);\n  return api.runTaskList(list, sessions, {\n    series: true,\n    verbose: api.verbose\n  });\n}\n\nexport function envconfig(api) {\n  log('exec => mup meteor envconfig');\n\n  const config = api.getConfig().app;\n  const servers = api.getConfig().servers;\n  let bindAddress = '0.0.0.0';\n\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  config.log = config.log || {\n    opts: {\n      'max-size': '100m',\n      'max-file': 10\n    }\n  };\n\n  config.nginx = config.nginx || {};\n\n  if (config.docker && config.docker.bind) {\n    bindAddress = config.docker.bind;\n  }\n\n  if (config.dockerImageFrontendServer) {\n    config.docker.imageFrontendServer = config.dockerImageFrontendServer;\n  }\n  if (!config.docker.imageFrontendServer) {\n    config.docker.imageFrontendServer = 'meteorhacks/mup-frontend-server';\n  }\n\n  // If imagePort is not set, go with port 80 which was the traditional\n  // port used by kadirahq/meteord and meteorhacks/meteord\n  config.docker.imagePort = config.docker.imagePort || 80;\n\n  if (config.ssl) {\n    config.ssl.port = config.ssl.port || 443;\n  }\n\n  const list = nodemiral.taskList('Configuring App');\n  list.copy('Pushing the Startup Script', {\n    src: api.resolvePath(__dirname, 'assets/templates/start.sh'),\n    dest: '/opt/' + config.name + '/config/start.sh',\n    vars: {\n      appName: config.name,\n      port: config.env.PORT || 80,\n      bind: bindAddress,\n      sslConfig: config.ssl,\n      logConfig: config.log,\n      volumes: config.volumes,\n      docker: config.docker,\n      proxyConfig: api.getConfig().proxy,\n      nginxClientUploadLimit: config.nginx.clientUploadLimit || '10M'\n    }\n  });\n\n  var env = cloneDeep(config.env);\n  env.METEOR_SETTINGS = JSON.stringify(api.getSettings());\n  // sending PORT to the docker container is useless.\n\n  // setting PORT in the config is used for the publicly accessible\n  // port.\n\n  // docker.imagePort is used for the port exposed from the container.\n  // In case the docker.imagePort is different than the container's\n  // default port, we set the env PORT to docker.imagePort.\n  env.PORT = config.docker.imagePort;\n\n  const hostVars = {};\n  Object.keys(config.servers).forEach(key => {\n    if (config.servers[key].env) {\n      hostVars[servers[key].host] = {env: config.servers[key].env};\n    }\n  });\n\n  list.copy('Sending Environment Variables', {\n    src: api.resolvePath(__dirname, 'assets/templates/env.list'),\n    dest: '/opt/' + config.name + '/config/env.list',\n    hostVars,\n    vars: {\n      env: env || {},\n      appName: config.name\n    }\n  });\n\n  const sessions = api.getSessions(['app']);\n  return api.runTaskList(list, sessions, {\n    series: true,\n    verbose: api.verbose\n  });\n}\n\nexport function start(api) {\n  log('exec => mup meteor start');\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  const list = nodemiral.taskList('Start Meteor');\n\n  list.executeScript('Start Meteor', {\n    script: api.resolvePath(__dirname, 'assets/meteor-start.sh'),\n    vars: {\n      appName: config.name\n    }\n  });\n\n  list.executeScript('Verifying Deployment', {\n    script: api.resolvePath(__dirname, 'assets/meteor-deploy-check.sh'),\n    vars: {\n      deployCheckWaitTime: config.deployCheckWaitTime || 60,\n      appName: config.name,\n      deployCheckPort: config.deployCheckPort || config.env.PORT || 80,\n      deployCheckPath: '',\n      host: api.getConfig().proxy ?\n        api.getConfig().proxy.domains.split(',')[0] :\n        null\n    }\n  });\n\n  const sessions = api.getSessions(['app']);\n  return api.runTaskList(list, sessions, {\n    series: true,\n    verbose: api.verbose\n  });\n}\n\nexport function deploy(api) {\n  log('exec => mup meteor deploy');\n\n  // validate settings and config before starting\n  api.getSettings();\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  return api\n    .runCommand('meteor.push')\n    .then(() => api.runCommand('meteor.envconfig'))\n    .then(() => api.runCommand('meteor.start'));\n}\n\nexport function stop(api) {\n  log('exec => mup meteor stop');\n  const config = api.getConfig().app;\n  if (!config) {\n    console.error('error: no configs found for meteor');\n    process.exit(1);\n  }\n\n  const list = nodemiral.taskList('Stop Meteor');\n\n  list.executeScript('Stop Meteor', {\n    script: api.resolvePath(__dirname, 'assets/meteor-stop.sh'),\n    vars: {\n      appName: config.name\n    }\n  });\n\n  const sessions = api.getSessions(['app']);\n  return api.runTaskList(list, sessions, { verbose: api.verbose });\n}\n\nexport function restart(api) {\n  const list = nodemiral.taskList('Restart Meteor');\n  const sessions = api.getSessions(['meteor']);\n  const config = api.getConfig().app;\n\n  list.executeScript('Stop Meteor', {\n    script: api.resolvePath(__dirname, 'assets/meteor-stop.sh'),\n    vars: {\n      appName: config.name\n    }\n  });\n\n  list.executeScript('Start Meteor', {\n    script: api.resolvePath(__dirname, 'assets/meteor-start.sh'),\n    vars: {\n      appName: config.name\n    }\n  });\n\n  list.executeScript('Verifying Deployment', {\n    script: api.resolvePath(__dirname, 'assets/meteor-deploy-check.sh'),\n    vars: {\n      deployCheckWaitTime: config.deployCheckWaitTime || 60,\n      appName: config.name,\n      deployCheckPort: config.deployCheckPort || config.env.PORT || 80,\n      deployCheckPath: '',\n      host: api.getConfig().proxy ?\n        api.getConfig().proxy.domains.split(',')[0] : null\n    }\n  });\n\n  return api.runTaskList(list, sessions, {\n    series: true,\n    verbose: api.verbose\n  });\n}\n"]}