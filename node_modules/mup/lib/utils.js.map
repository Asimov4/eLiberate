{"version":3,"sources":["../src/utils.js"],"names":["addStdioHandlers","runTaskList","getDockerLogs","createSSHOptions","runSSHCommand","countOccurences","resolvePath","filterArgv","log","list","_taskQueue","map","task","options","onStdout","process","stdout","write","data","onStderr","stderr","sessions","opts","verbose","Promise","resolve","reject","run","host","summaryMap","hasOwnProperty","summary","error","nodemiralHistory","history","Callback2Stream","reading","push","forEach","shouldContinue","shift","Readable","name","args","command","join","promises","input","session","_host","lineSeperator","createInterface","terminal","on","console","addData","execute","bind","all","server","sshAgent","env","SSH_AUTH_SOCK","ssh","port","username","pem","privateKey","readFileSync","password","existsSync","agent","info","conn","connect","once","err","exec","outputStream","end","output","code","needle","haystack","regex","RegExp","match","length","paths","expandedPaths","_path","argvArray","argv","unwanted","result","_","slice","Object","keys","add","key","_key","indexOf","undefined"],"mappings":"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","file":"utils.js","sourcesContent":["import { Client } from 'ssh2';\nimport debug from 'debug';\nimport expandTilde from 'expand-tilde';\nimport fs from 'fs';\nimport path from 'path';\nimport { promisify } from 'bluebird';\nimport stream from 'stream';\nimport readline from 'readline';\n\nconst log = debug('mup:utils');\n\nexport function addStdioHandlers(list) {\n  list._taskQueue = list._taskQueue.map(task => {\n    task.options = task.options || {};\n\n    task.options.onStdout = () => {\n      return data => {\n        process.stdout.write(data);\n      };\n    };\n\n    task.options.onStderr = () => {\n      return data => {\n        process.stderr.write(data);\n      };\n    };\n    return task;\n  });\n}\n\nexport function runTaskList(list, sessions, opts) {\n  if (opts && opts.verbose) {\n    addStdioHandlers(list);\n    delete opts.verbose;\n  }\n  return new Promise((resolve, reject) => {\n    list.run(sessions, opts, summaryMap => {\n      for (var host in summaryMap) {\n        if (summaryMap.hasOwnProperty(host)) {\n          const summary = summaryMap[host];\n          if (summary.error) {\n            let error = summary.error;\n            error.nodemiralHistory = summary.history;\n            reject(error);\n\n            return;\n          }\n        }\n      }\n\n      resolve();\n    });\n  });\n}\n\n// Implements a simple readable stream to pass\n// the logs from nodemiral to readline which\n// then splits it into individual lines.\nclass Callback2Stream extends stream.Readable {\n  constructor(options) {\n    // Calls the stream.Readable(options) constructor\n    super(options);\n\n    this.data = [];\n  }\n  addData(data) {\n    if (this.reading) {\n      this.reading = this.push(data);\n    } else {\n      this.data.push(data);\n    }\n  }\n  _read() {\n    this.reading = true;\n    this.data.forEach(() => {\n      let shouldContinue = this.reading && this.push(this.data.shift());\n      if (!shouldContinue) {\n        this.reading = false;\n      }\n    });\n  }\n}\n\nexport function getDockerLogs(name, sessions, args) {\n  const command = 'sudo docker ' + args.join(' ') + ' ' + name + ' 2>&1';\n\n  log(`getDockerLogs command: ${command}`);\n\n  let promises = sessions.map(session => {\n    const input = new Callback2Stream();\n    const host = '[' + session._host + ']';\n    const lineSeperator = readline.createInterface({\n      input,\n      terminal: true\n    });\n    lineSeperator.on('line', data => {\n      console.log(host + data);\n    });\n    const options = {\n      onStdout: data => {\n        input.addData(data);\n      },\n      onStderr: data => {\n        // the logs all come in on stdout so stderr isn't added to lineSeperator\n        process.stdout.write(host + data);\n      }\n    };\n    return promisify(session.execute.bind(session))(command, options);\n  });\n  return Promise.all(promises);\n}\n\nexport function createSSHOptions(server) {\n  var sshAgent = process.env.SSH_AUTH_SOCK;\n  var ssh = {\n    host: server.host,\n    port: (server.opts && server.opts.port) || 22,\n    username: server.username\n  };\n\n  if (server.pem) {\n    ssh.privateKey = fs.readFileSync(resolvePath(server.pem), 'utf8');\n  } else if (server.password) {\n    ssh.password = server.password;\n  } else if (sshAgent && fs.existsSync(sshAgent)) {\n    ssh.agent = sshAgent;\n  }\n  return ssh;\n}\n\n// Maybe we should create a new npm package\n// for this one. Something like 'sshelljs'.\nexport function runSSHCommand(info, command) {\n  return new Promise((resolve, reject) => {\n    const conn = new Client();\n\n    // TODO better if we can extract SSH agent info from original session\n    var sshAgent = process.env.SSH_AUTH_SOCK;\n    var ssh = {\n      host: info.host,\n      port: (info.opts && info.opts.port) || 22,\n      username: info.username\n    };\n\n    if (info.pem) {\n      ssh.privateKey = fs.readFileSync(resolvePath(info.pem), 'utf8');\n    } else if (info.password) {\n      ssh.password = info.password;\n    } else if (sshAgent && fs.existsSync(sshAgent)) {\n      ssh.agent = sshAgent;\n    }\n    conn.connect(ssh);\n\n    conn.once('error', function(err) {\n      if (err) {\n        reject(err);\n      }\n    });\n\n    // TODO handle error events\n    conn.once('ready', function() {\n      conn.exec(command, function(err, outputStream) {\n        if (err) {\n          conn.end();\n          reject(err);\n          return;\n        }\n\n        let output = '';\n\n        outputStream.on('data', function(data) {\n          output += data;\n        });\n\n        outputStream.once('close', function(code) {\n          conn.end();\n          resolve({ code, output });\n        });\n      });\n    });\n  });\n}\n\nexport function countOccurences(needle, haystack) {\n  const regex = new RegExp(needle, 'g');\n  const match = haystack.match(regex) || [];\n  return match.length;\n}\n\nexport function resolvePath(...paths) {\n  let expandedPaths = paths.map(_path => {\n    return expandTilde(_path);\n  });\n  return path.resolve(...expandedPaths);\n}\n\nexport function filterArgv(argvArray, argv, unwanted) {\n  let result = argv._.slice();\n  Object.keys(argv).forEach(_key => {\n    let add = false;\n    let key = _key;\n    if (\n      unwanted.indexOf(key) === -1 &&\n      argv[key] !== false &&\n      argv[key] !== undefined\n    ) {\n      add = true;\n    }\n\n    if (key.length > 1) {\n      key = `--${key}`;\n    } else {\n      key = `-${key}`;\n    }\n\n    if (add) {\n      if (argvArray.indexOf(key) === -1) {\n        return;\n      }\n\n      result.push(key);\n\n      if (typeof argv[_key] !== 'boolean') {\n        result.push(argv[_key]);\n      }\n    }\n\n  });\n\n  return result;\n}\n"]}